#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdbool.h>
#include <float.h>

// ================== Conv1d: conv1 ================== //
// Weight for conv1d: 5x20x3 @out_channels x in_channels x kernel_size;
float conv1_weights[300] = {0.10449219, -0.11212158, -0.03021240, 0.04669189, 0.07354736, -0.08538818, -0.09899902, 0.11431885, 0.05700684, -0.06591797, 0.09393311, -0.12597656, -0.01837158, -0.02897644, 0.03225708, -0.01878357, -0.08880615, -0.03219604, -0.09216309, -0.08459473, -0.08026123, 0.10833740, -0.09197998, -0.05923462, 0.00865173, 0.09454346, 0.02607727, -0.12280273, -0.06762695, 0.12487793, -0.00633621, -0.09344482, 0.08251953, -0.01430511, 0.04425049, -0.03445435, -0.06353760, 0.03424072, 0.10406494, 0.10021973, -0.04931641, 0.04034424, 0.10845947, 0.09277344, -0.04483032, -0.05892944, 0.12457275, 0.09765625, 0.03158569, -0.07183838, 0.08081055, -0.11260986, -0.10095215, -0.04763794, 0.05880737, -0.12902832, 0.11291504, -0.01276398, -0.00261497, 0.01712036, -0.07647705, -0.03375244, 0.11499023, -0.01951599, -0.05776978, 0.00231361, 0.12866211, -0.09533691, 0.01004791, 0.06811523, -0.12805176, 0.04663086, -0.01687622, -0.02536011, -0.05291748, 0.04278564, 0.08099365, 0.10595703, 0.01031494, -0.11962891, -0.03350830, 0.12719727, -0.03958130, 0.03115845, 0.12585449, 0.04757690, 0.11181641, -0.12744141, -0.11309814, 0.09057617, -0.06445312, -0.02073669, -0.10595703, -0.06506348, 0.06323242, 0.05245972, 0.03616333, -0.06378174, 0.09332275, -0.09008789, -0.02656555, 0.12194824, -0.00086212, 0.03958130, 0.03890991, -0.07788086, 0.08837891, -0.12805176, 0.03013611, -0.08477783, -0.02864075, 0.10491943, 0.02975464, -0.04330444, -0.03088379, 0.01313019, -0.05828857, 0.09222412, -0.06744385, -0.11938477, -0.07464600, 0.02423096, 0.01410675, 0.08081055, -0.10784912, -0.04904175, -0.11004639, 0.07629395, 0.04656982, 0.08746338, 0.05285645, -0.00680161, 0.08862305, -0.02764893, -0.01766968, -0.05041504, 0.12866211, -0.06414795, 0.08654785, 0.01216888, -0.02990723, 0.10614014, 0.03387451, 0.00225067, 0.06744385, -0.00297546, 0.10797119, 0.07635498, 0.08581543, 0.02777100, 0.04956055, -0.01396179, 0.00794220, 0.02682495, -0.05847168, -0.05841064, 0.04522705, -0.00463867, -0.07043457, 0.05062866, -0.06323242, 0.10852051, 0.00867462, 0.12890625, 0.04263306, 0.10467529, 0.10998535, -0.08953857, 0.03634644, 0.00269508, 0.01692200, -0.03439331, -0.06744385, 0.12695312, 0.07128906, -0.12683105, 0.04830933, 0.02786255, 0.11846924, -0.12280273, 0.07690430, 0.05187988, -0.04446411, -0.09936523, 0.08190918, -0.00370979, 0.05139160, -0.03979492, 0.04150391, 0.11041260, -0.11260986, -0.06915283, -0.01567078, 0.00657272, 0.02825928, 0.01138306, -0.09777832, 0.03860474, -0.01442719, 0.06192017, -0.06311035, 0.08770752, -0.12585449, -0.10266113, 0.09399414, -0.01068878, 0.01614380, 0.03448486, -0.05944824, 0.12609863, -0.03543091, 0.11138916, 0.06689453, -0.01437378, -0.08160400, -0.01087952, 0.12731934, -0.12091064, 0.06939697, -0.04772949, 0.09722900, -0.07086182, 0.08557129, 0.00891113, 0.03549194, 0.06945801, 0.01991272, 0.03976440, 0.03079224, 0.00151157, -0.11328125, 0.07958984, -0.07904053, 0.09149170, 0.00592041, 0.00279808, -0.07043457, 0.00576019, -0.03445435, -0.01170349, 0.08392334, 0.06860352, 0.01023102, 0.08343506, 0.03128052, 0.07812500, 0.10235596, 0.02183533, -0.06149292, -0.04553223, 0.00529861, -0.12200928, 0.00544739, -0.07061768, -0.05947876, 0.04614258, -0.08007812, -0.10662842, -0.12609863, 0.08758545, -0.08636475, 0.02799988, -0.01428986, -0.04879761, -0.01435089, -0.04974365, 0.04043579, 0.12274170, 0.01264954, -0.00506210, 0.10119629, 0.05490112, -0.12512207, 0.00149727, 0.11535645, -0.08349609, -0.10711670, 0.10168457, -0.02711487, 0.11169434, -0.09625244, -0.05282593, 0.02488708, -0.11621094, 0.06555176, 0.05493164, 0.04644775, 0.09765625, 0.10980225, 0.05746460, -0.01574707, -0.09490967, -0.02310181, 0.00587845, -0.02062988, 0.00544739, 0.12829590, 0.08007812, -0.04809570, 0.03430176};
// Bias for conv1d: 5 @out_channels;
float conv1_bias[5] = {0.01760864, 0.06091309, 0.01914978, 0.04394531, -0.03701782};

// ================== MaxPool1d: max_pool1d ================== //
// MaxPool1d for layer: max_pool1d;

// ================== Flatten: flatten ================== //
// Flatten for layer: flatten;

// ================== Layer: fc1 ================== //
// Transposed weights for layer: fc1 @20x32;
float fc1_weight_transposed[640] = {0.02694702, -0.00591660, 0.03268433, 0.15466309, 0.01593018, -0.07635498, -0.05038452, 0.17590332, 0.17761230, 0.07769775, 0.12457275, -0.21936035, -0.03689575, 0.07879639, -0.15637207, -0.14709473, -0.09887695, -0.01170349, 0.20251465, -0.08679199, 0.21643066, -0.04187012, -0.13232422, 0.20861816, -0.17541504, 0.22253418, -0.11218262, -0.00728226, 0.15234375, 0.20837402, 0.15991211, -0.20959473, 0.05258179, -0.10467529, -0.07379150, -0.14111328, -0.15136719, -0.11328125, -0.08819580, -0.20349121, 0.16223145, -0.09741211, -0.06732178, 0.03729248, -0.13488770, 0.02561951, 0.05026245, 0.12091064, -0.00204086, -0.00341797, -0.13122559, -0.09600830, 0.19177246, -0.03909302, 0.08880615, -0.08947754, 0.13134766, -0.16809082, 0.17431641, 0.12524414, -0.04644775, 0.13769531, 0.16674805, -0.18066406, 0.01838684, 0.10327148, 0.13598633, 0.19091797, -0.22094727, 0.04281616, 0.19213867, -0.03854370, -0.04833984, -0.03707886, 0.20275879, -0.20336914, 0.13732910, 0.10711670, 0.12719727, -0.09313965, -0.15917969, 0.06518555, 0.08074951, 0.17187500, 0.09857178, 0.07720947, 0.14013672, -0.05703735, -0.11907959, 0.13183594, 0.17260742, -0.10552979, 0.01597595, -0.15136719, -0.10211182, 0.04898071, 0.04470825, -0.06256104, -0.19128418, -0.04193115, 0.11315918, 0.07452393, 0.04119873, -0.04605103, 0.19409180, 0.17346191, 0.00819397, -0.06951904, 0.20922852, -0.13171387, 0.16601562, -0.18005371, -0.13964844, 0.21911621, -0.17102051, 0.17138672, 0.18322754, -0.02421570, 0.03445435, -0.05871582, 0.17651367, -0.11053467, 0.15576172, -0.13769531, 0.04663086, -0.11315918, -0.01015472, -0.11303711, 0.17663574, -0.02809143, 0.07763672, -0.09149170, 0.13024902, -0.13439941, 0.20520020, -0.20153809, 0.21032715, 0.09484863, -0.08428955, 0.12023926, -0.02029419, -0.05850220, -0.11700439, -0.17016602, 0.15087891, -0.16894531, -0.13024902, 0.02157593, -0.11254883, -0.02549744, -0.07452393, -0.03222656, 0.05899048, -0.04443359, -0.00597000, -0.11114502, 0.14331055, 0.00236702, -0.01770020, 0.02062988, -0.10540771, -0.11901855, 0.20043945, -0.07879639, -0.01574707, -0.21704102, 0.07830811, 0.00437164, -0.16101074, 0.19726562, -0.01177216, 0.14038086, 0.06384277, 0.01106262, -0.21679688, -0.03918457, 0.05206299, -0.00754166, 0.06933594, 0.07684326, -0.08551025, 0.02250671, -0.18798828, -0.15417480, -0.21032715, -0.01710510, -0.17968750, 0.22302246, 0.02291870, 0.03723145, 0.00799561, 0.01379395, 0.19873047, 0.13366699, 0.19897461, 0.01622009, 0.12316895, 0.00125027, 0.08654785, 0.14038086, -0.11889648, -0.02476501, 0.02328491, 0.04977417, 0.20666504, -0.20471191, -0.18176270, 0.02093506, -0.21069336, 0.14538574, 0.13696289, -0.21582031, 0.12487793, -0.07458496, -0.13085938, -0.05386353, -0.21801758, -0.03155518, 0.03007507, 0.09686279, -0.20056152, 0.09686279, -0.21057129, 0.17138672, -0.06713867, -0.02192688, 0.01702881, -0.18701172, 0.19177246, -0.04049683, -0.14953613, -0.10363770, 0.09222412, -0.11016846, -0.09381104, 0.19335938, -0.08105469, -0.18640137, -0.09747314, 0.20373535, 0.07153320, -0.15515137, 0.19750977, 0.10925293, -0.18420410, 0.11627197, 0.10998535, -0.14123535, -0.18579102, 0.04391479, 0.12805176, 0.17358398, 0.09313965, 0.02909851, 0.21875000, -0.04360962, 0.14965820, -0.07464600, -0.10699463, -0.09997559, 0.17761230, -0.06143188, 0.18554688, -0.09667969, 0.19262695, -0.11706543, -0.17553711, 0.12109375, 0.13342285, -0.21813965, 0.17846680, 0.04443359, -0.05606079, 0.16040039, 0.12011719, -0.16174316, -0.03092957, -0.05947876, -0.09747314, -0.00030112, 0.20434570, 0.02426147, 0.10711670, -0.02322388, 0.18261719, 0.00035501, 0.04226685, -0.15979004, -0.05105591, -0.00595474, 0.18176270, 0.03283691, -0.19604492, -0.09460449, -0.01062775, -0.19152832, 0.17883301, -0.21093750, 0.03530884, 0.01882935, 0.19482422, -0.00651932, -0.15063477, -0.11114502, 0.15393066, -0.09307861, 0.20617676, 0.03762817, -0.03945923, -0.10882568, 0.17932129, 0.09356689, -0.04788208, -0.16052246, 0.18090820, -0.12902832, 0.14282227, -0.20312500, -0.14685059, 0.14709473, -0.20166016, 0.15759277, -0.20812988, 0.00103283, -0.04846191, -0.08312988, 0.08227539, 0.01519012, -0.13049316, 0.11169434, 0.14709473, 0.15808105, 0.01708984, 0.13134766, 0.18688965, 0.01321411, -0.19348145, 0.19128418, 0.09100342, 0.07043457, -0.08984375, 0.18823242, 0.21752930, -0.22290039, -0.10858154, -0.08489990, 0.02149963, 0.09985352, 0.14501953, -0.20031738, -0.21655273, -0.15234375, 0.05181885, 0.07409668, 0.14990234, -0.09143066, -0.21105957, -0.22180176, -0.13330078, 0.17224121, 0.17309570, 0.00001681, -0.16540527, 0.02487183, 0.08734131, 0.16735840, 0.12622070, 0.13439941, 0.16479492, 0.11291504, 0.16259766, 0.08850098, 0.04080200, 0.08416748, -0.02822876, 0.09753418, -0.09161377, -0.00392532, 0.20239258, 0.20495605, 0.05688477, -0.08782959, -0.12329102, -0.13378906, -0.21032715, -0.13452148, -0.21435547, 0.20458984, -0.18005371, 0.06756592, 0.12658691, -0.18188477, -0.08337402, -0.10272217, -0.21960449, 0.04138184, 0.14941406, 0.21655273, 0.13208008, 0.10076904, -0.14379883, -0.18041992, 0.11206055, 0.12078857, -0.20263672, 0.02668762, -0.09442139, -0.10375977, -0.08697510, 0.15576172, -0.10015869, 0.06402588, -0.18298340, -0.06939697, 0.03262329, 0.16662598, 0.08349609, -0.18115234, -0.13391113, -0.19604492, -0.04483032, -0.07794189, 0.08319092, 0.14172363, -0.19897461, -0.07092285, -0.05401611, -0.03573608, -0.03845215, 0.16113281, 0.16955566, -0.12280273, -0.13391113, 0.16198730, 0.11322021, -0.15466309, 0.19567871, -0.02622986, -0.19836426, -0.01027679, -0.01724243, -0.11254883, -0.00787354, -0.03497314, 0.04739380, 0.09472656, 0.18579102, 0.05813599, -0.18408203, -0.17529297, 0.05441284, 0.21044922, -0.01965332, 0.15734863, -0.05160522, -0.11181641, -0.09893799, 0.12493896, 0.17285156, 0.18054199, -0.11450195, 0.00739288, 0.04098511, -0.00629044, -0.14941406, -0.10583496, -0.17907715, 0.05801392, -0.13000488, -0.00084925, -0.04156494, -0.12500000, -0.05499268, 0.05770874, -0.16662598, 0.19055176, 0.16418457, 0.20642090, -0.10113525, 0.04403687, -0.03991699, 0.02182007, 0.13134766, 0.14147949, -0.02099609, -0.18286133, 0.04013062, -0.22082520, 0.16833496, -0.09771729, 0.01304626, -0.15832520, 0.12951660, 0.03756714, 0.16906738, 0.14807129, -0.12841797, -0.17907715, -0.02148438, -0.19458008, -0.19384766, 0.20581055, 0.05847168, 0.04574585, 0.02294922, -0.15881348, -0.16406250, 0.01969910, 0.12707520, 0.13110352, 0.07818604, 0.02528381, -0.13623047, -0.01334381, 0.06866455, -0.05914307, 0.16845703, -0.05072021, 0.16906738, -0.06707764, -0.09533691, 0.04730225, 0.21154785, -0.10522461, -0.01348877, -0.15930176, -0.15588379, -0.01491547, -0.11029053, -0.01004791, -0.12646484, -0.19555664, 0.00152206, -0.08386230, 0.13195801, -0.05154419, -0.15820312, 0.01476288, -0.05163574, 0.19641113, 0.08392334, 0.21337891, 0.16345215, -0.08465576, 0.04421997, 0.18249512, 0.19262695, 0.21264648, -0.19079590, -0.01971436, -0.21557617, 0.02044678, -0.12597656, -0.15124512, 0.13220215, -0.09765625, 0.13000488, -0.15368652, -0.14636230, -0.14758301, 0.19470215, 0.21716309, 0.10833740, -0.17504883, -0.17919922, 0.01316833, -0.21923828, -0.19750977, 0.13867188, -0.20300293, 0.12487793, 0.04373169, -0.09912109, -0.21435547, 0.00138855, 0.18347168, 0.16528320, 0.20849609, 0.00453568, 0.17419434, -0.18554688, 0.06585693, 0.09094238, -0.19067383, 0.15002441, 0.06033325, -0.13269043, -0.03408813, 0.14184570, -0.02307129, -0.00298309, -0.02182007, 0.15734863, 0.03823853, 0.04049683, 0.03359985, 0.09509277, -0.06182861, -0.10736084, -0.16796875, 0.15100098, -0.14575195, -0.04925537, -0.15856934, -0.16845703, -0.22106934, -0.10815430, 0.12731934, 0.14501953, 0.05648804, 0.09436035, -0.12548828, 0.07470703, 0.05517578, -0.01277924, 0.08654785, -0.12310791, -0.03451538, 0.20043945, -0.07482910, -0.11834717, 0.08447266, 0.08978271, 0.14208984, -0.05072021, 0.09539795, 0.20764160, 0.15966797, 0.05758667, -0.18383789, 0.20666504, 0.00831604, 0.04052734, -0.19702148, 0.18688965, -0.05462646, 0.02301025, -0.03948975, 0.12731934, -0.10089111};
// Biases for layer: fc1 @32;
float fc1_bias_transposed[32] = {-0.07342529, -0.09307861, 0.21716309, -0.05383301, -0.09240723, 0.15039062, -0.05279541, 0.19592285, -0.04913330, 0.07000732, 0.19824219, 0.17077637, 0.00670242, -0.07574463, -0.16076660, -0.05969238, -0.02639771, 0.20751953, -0.08551025, -0.08410645, 0.03692627, 0.05264282, -0.19189453, -0.19812012, 0.02958679, -0.14855957, 0.20056152, 0.03335571, 0.09136963, 0.08264160, -0.01507568, 0.19433594};

// ================== Relu: relu1 ================== //
// Relu for layer: relu1;

// ================== Layer: fc2 ================== //
// Transposed weights for layer: fc2 @32x10;
float fc2_weight_transposed[320] = {0.12561035, 0.11242676, -0.00489807, -0.08245850, -0.07342529, -0.12561035, 0.16345215, -0.16455078, 0.00854492, -0.01226807, 0.12261963, 0.15771484, 0.08905029, 0.10504150, 0.06262207, 0.04852295, 0.05200195, 0.13488770, 0.17065430, 0.02697754, 0.14099121, 0.10400391, 0.00116444, 0.10229492, 0.15148926, 0.04962158, 0.10205078, 0.13964844, -0.01485443, -0.01930237, 0.06646729, -0.05770874, -0.05636597, 0.11804199, -0.15844727, -0.09606934, 0.02037048, -0.10394287, -0.08544922, 0.02584839, 0.00658417, -0.04437256, 0.03964233, 0.06262207, -0.07891846, -0.03988647, -0.12164307, -0.06475830, -0.07592773, 0.17297363, 0.03802490, 0.16088867, -0.04122925, 0.01259613, -0.16076660, 0.00274467, 0.06695557, -0.16210938, -0.09771729, -0.12402344, 0.12042236, 0.06530762, 0.01518250, -0.06872559, 0.04562378, -0.17065430, -0.09631348, -0.12036133, 0.09692383, 0.15173340, -0.03021240, -0.09985352, -0.15795898, -0.06658936, -0.08203125, -0.00785065, -0.14453125, 0.05972290, -0.08050537, 0.14611816, 0.03811646, 0.11212158, -0.01221466, 0.14343262, 0.16210938, -0.07867432, -0.09655762, 0.05645752, 0.09680176, 0.07403564, 0.11676025, -0.01074982, -0.02746582, -0.17004395, -0.12878418, -0.11907959, -0.03588867, 0.08569336, -0.17395020, -0.00486374, -0.17529297, 0.02418518, 0.09716797, 0.11511230, -0.07360840, -0.17578125, 0.14916992, 0.11322021, 0.01937866, -0.11614990, -0.01841736, -0.07702637, 0.00379944, -0.15747070, -0.14868164, -0.02301025, -0.12780762, -0.12707520, -0.17333984, 0.10937500, -0.07775879, -0.16137695, 0.16418457, -0.05154419, -0.09698486, 0.06445312, -0.00239182, 0.05322266, -0.12683105, 0.03256226, -0.17041016, 0.07025146, -0.06640625, 0.00655746, -0.08648682, -0.04382324, -0.17578125, -0.16284180, -0.01834106, 0.03543091, 0.00292969, -0.01908875, -0.07495117, 0.16979980, 0.06921387, -0.00260925, 0.04205322, 0.09588623, 0.00773239, 0.08917236, -0.16418457, -0.12182617, 0.08874512, -0.12927246, 0.11590576, 0.06628418, -0.01080322, -0.10552979, -0.01490784, 0.05599976, 0.15881348, 0.12097168, 0.02232361, 0.03768921, 0.05554199, -0.16711426, -0.10083008, -0.15832520, -0.09771729, 0.17370605, 0.11688232, 0.04135132, -0.04040527, 0.03097534, 0.03280640, -0.16857910, 0.00606537, 0.03030396, -0.13671875, 0.14306641, -0.14086914, -0.14477539, -0.07678223, -0.13171387, 0.02050781, -0.01699829, 0.16394043, 0.07928467, 0.02740479, -0.04827881, 0.08544922, -0.09338379, -0.15100098, -0.09545898, -0.07714844, 0.11816406, -0.17028809, 0.13061523, 0.07946777, -0.17480469, -0.03796387, 0.16479492, -0.12805176, -0.11901855, 0.10052490, -0.03102112, -0.00315094, -0.02433777, 0.15136719, 0.14404297, -0.05645752, 0.01655579, -0.06701660, -0.16918945, -0.03735352, -0.01623535, 0.04840088, -0.08166504, 0.12316895, -0.17456055, -0.00909424, 0.02113342, 0.16223145, -0.16186523, -0.04843140, 0.13281250, 0.03041077, 0.10821533, -0.05703735, -0.02987671, -0.06033325, 0.16906738, 0.11114502, -0.05291748, -0.07550049, -0.15808105, -0.08508301, 0.09423828, -0.01786804, -0.03588867, 0.08142090, 0.10900879, 0.17529297, -0.10601807, 0.15844727, -0.08697510, 0.01468658, -0.01931763, -0.13159180, 0.13769531, 0.12915039, 0.15222168, -0.00590515, -0.01989746, -0.12078857, 0.14392090, 0.14697266, 0.07769775, -0.15856934, -0.15075684, -0.16650391, 0.10473633, -0.12817383, -0.11407471, -0.05465698, -0.02822876, 0.01759338, 0.00551605, -0.04180908, -0.10754395, -0.17346191, 0.05593872, 0.14160156, 0.13708496, -0.00821686, -0.16247559, 0.07733154, -0.05084229, 0.07690430, -0.06463623, 0.02613831, -0.06048584, -0.08319092, -0.06579590, -0.14501953, -0.00572205, 0.10308838, 0.15698242, -0.04763794, 0.06072998, -0.05044556, 0.09118652, -0.05282593, -0.05624390, 0.06701660, -0.15905762, 0.13903809, -0.06158447, -0.16406250, -0.13342285, -0.06234741, -0.10717773, 0.14013672, -0.10742188, 0.14562988, -0.03927612, -0.14099121, -0.01582336, -0.09735107, 0.13208008, -0.11614990, 0.04382324, 0.00396347, -0.16784668, 0.09106445, -0.00143337, -0.09753418, 0.17004395, -0.15454102, 0.12176514};
// Biases for layer: fc2 @10;
float fc2_bias_transposed[10] = {0.05197144, 0.08605957, 0.04403687, 0.13330078, -0.16027832, -0.08435059, -0.12548828, -0.09533691, -0.01189423, -0.01273346};

// ================== SoftMax: softmax ================== //
// SoftMax for layer: softmax;

float *Conv1d(int batch_size, int in_channels, int sequence_length, float *input, int out_channels, int kernel_size, int stride, int padding, float *weights, float *bias, bool use_bias)
{
    // 修正后的 output_length 计算方式
    int output_length = (sequence_length - kernel_size + stride) / stride;

    float *output_array = (float *)malloc(batch_size * out_channels * output_length * sizeof(float));

    // 手动计算卷积
    for (int n = 0; n < batch_size; ++n)
    {
        for (int c_out = 0; c_out < out_channels; ++c_out)
        {
            for (int i = 0; i < output_length; ++i)
            {
                float conv_sum = 0.0f;
                for (int c_in = 0; c_in < in_channels; ++c_in)
                {
                    int start_idx = c_out * in_channels * kernel_size + c_in * kernel_size;
                    for (int k = 0; k < kernel_size; ++k)
                    {
                        int input_idx = n * in_channels * sequence_length + c_in * sequence_length + (i * stride + k);
                        int weight_idx = start_idx + k;
                        conv_sum += input[input_idx] * weights[weight_idx];
                    }
                }
                int output_idx = n * out_channels * output_length + c_out * output_length + i;
                output_array[output_idx] = conv_sum;

                // 添加偏置项
                if (use_bias)
                {
                    output_array[output_idx] += bias[c_out];
                }
            }
        }
    }

    return output_array;
}
// MaxPool1D 函数
float *MaxPool1D(int batch_size, int elements_length, int pool_size, int stride, int padding, float *input)
{
    int padded_length = elements_length + 2 * padding;
    int output_length = (padded_length - pool_size) / stride + 1;

    float *output = (float *)malloc(batch_size * output_length * sizeof(float));

    for (int b = 0; b < batch_size; b++)
    {
        for (int i = 0; i < output_length; i++)
        {
            int start_index = i * stride - padding;
            float max_value = (start_index >= 0 && start_index < elements_length) ? input[b * elements_length + start_index] : -FLT_MAX;

            for (int j = 1; j < pool_size; j++)
            {
                int index = start_index + j;
                if (index >= 0 && index < elements_length)
                {
                    float value = input[b * elements_length + index];
                    if (value > max_value)
                    {
                        max_value = value;
                    }
                }
            }
            output[b * output_length + i] = max_value;
        }
    }
    return output;
}
float *Linear(int batch_size, int input_size, int output_size, float *input, float *weight_transposed, float *bias)
{
    int i, j, k;

    // 为结果矩阵分配内存
    float *result = (float *)malloc(batch_size * output_size * sizeof(float));
    if (result == NULL)
    {
        printf("Error: Memory allocation failed.\n");
        return NULL;
    }

    // 初始化并执行矩阵乘法
    for (i = 0; i < batch_size; i++)
    {
        for (j = 0; j < output_size; j++)
        {
            result[i * output_size + j] = 0; // 初始化元素为0
            for (k = 0; k < input_size; k++)
            {
                result[i * output_size + j] += input[i * input_size + k] * weight_transposed[k * output_size + j];
            }
            result[i * output_size + j] += bias[j]; // 将偏置项加到结果中
        }
    }

    // 返回结果矩阵
    return result;
}
void Relu(int batch_size, int elements_length, float *input)
{
    for (int i = 0; i < batch_size * elements_length; i++)
    {
        if (input[i] < 0)
        {
            input[i] = 0;
        }
    }
}
void SoftMax(int batch_size, int elements_length, float *input)
{
    float max_value, sum_exp;

    // 逐行计算softmax
    for (int i = 0; i < batch_size; i++)
    {
        // 找到该行的最大值
        max_value = input[i * elements_length];
        for (int j = 1; j < elements_length; j++)
        {
            if (input[i * elements_length + j] > max_value)
            {
                max_value = input[i * elements_length + j];
            }
        }

        // 计算该行的指数和
        sum_exp = 0.0f;
        for (int j = 0; j < elements_length; j++)
        {
            input[i * elements_length + j] = exp(input[i * elements_length + j] - max_value);
            sum_exp += input[i * elements_length + j];
        }

        // 归一化得到softmax输出
        for (int j = 0; j < elements_length; j++)
        {
            input[i * elements_length + j] /= sum_exp;
        }
    }
}

float *forward(float input[], float output[])
{
    float *result_0 = (float *)malloc(sizeof(float) * 480);
    for (int i = 0; i < 480; i++)
    {
        result_0[i] = input[i];
    }
    // conv1_layer
    // conv1_layer(batch_size: 1, in_channels: 20, sequence_length: 24)
    // => @(batch_size: 1, out_channels: 5, out_sequence_length: 8)
    float *result_1 = Conv1d(1, 20, 24, result_0, 5, 3, 3, 0, conv1_weights, conv1_bias, true);
    free(result_0);
    // max_pool1d_layer
    // output_size: 20
    float *result_2 = MaxPool1D(1, 40, 2, 2, 0, result_1);
    free(result_1);
    // flatten_layer
    // fc1_layer
    float *result_3 = Linear(1, 20, 32, result_2, fc1_weight_transposed, fc1_bias_transposed);
    free(result_2);
    // relu1_relu
    Relu(1, 32, result_3);
    // fc2_layer
    float *result_4 = Linear(1, 32, 10, result_3, fc2_weight_transposed, fc2_bias_transposed);
    free(result_3);
    // softmax_layer
    SoftMax(1, 10, result_4);
    for (int i = 0; i < 10; i++)
    {
        output[i] = result_4[i];
    }
    free(result_4);
}
int main()
{
    float input[480] = {-1.25084388256073, -0.6586713790893555, -0.168331578373909, 0.5770027041435242, -0.04045769199728966, -1.786649227142334, -0.23989729583263397, -0.10552999377250671, -0.02609942853450775, -0.8390645384788513, -1.0602346658706665, 2.7985341548919678, 0.3174891173839569, 2.4609806537628174, -1.1529507637023926, -0.06408462673425674, -0.2581776976585388, -1.1914983987808228, -0.38418498635292053, 1.6133145093917847, -0.08931974321603775, -1.1840181350708008, 0.7553942799568176, -0.5359848737716675, 0.6271563172340393, 0.39778584241867065, -0.646166980266571, -0.990456223487854, 0.02368350140750408, 0.2823561728000641, 1.1125831604003906, -0.16237588226795197, 0.9903122186660767, -0.27142634987831116, 1.093228816986084, -0.8227846622467041, 0.22423668205738068, -1.595008373260498, -0.955174446105957, 0.0880340114235878, -0.8983789682388306, 0.6647647023200989, -1.3846946954727173, 1.999847412109375, 0.2755470871925354, -0.8407137393951416, -1.6082843542099, -1.0132333040237427, -1.8681683540344238, 1.8323545455932617, 0.516783595085144, 1.9125574827194214, 1.1130136251449585, -0.7223562598228455, -0.017308173701167107, -0.24466164410114288, -0.5432563424110413, 0.791779637336731, -1.0486756563186646, 0.0036457995884120464, -0.15706901252269745, -0.8617392182350159, -1.7515193223953247, -0.408789724111557, 0.6080012917518616, 1.4263317584991455, -0.9411503076553345, 1.1739836931228638, -0.29256731271743774, -0.12775348126888275, 1.10741126537323, -0.4750858545303345, 2.187006950378418, 0.8100071549415588, -0.039310965687036514, 0.7356273531913757, -0.23710568249225616, -0.05315569043159485, 0.990982711315155, -1.103094220161438, -0.7755832672119141, 1.1942479610443115, -0.5146099925041199, 1.120932936668396, 0.28274866938591003, -0.6529105305671692, 0.08886606991291046, -1.2254016399383545, 1.523890733718872, -0.35637736320495605, 1.2715749740600586, 0.21188241243362427, -0.47532063722610474, 1.4816392660140991, -0.27964428067207336, 1.3269877433776855, 1.6924830675125122, -1.1103382110595703, 1.2657841444015503, -0.8830244541168213, 0.8258317708969116, -1.192674994468689, -1.0894263982772827, 0.014936620369553566, 0.9695184826850891, -0.16579985618591309, 0.41906315088272095, -0.0005354536115191877, 1.1770238876342773, 0.13586048781871796, 0.31297609210014343, -1.0799689292907715, 0.20677487552165985, 0.13704493641853333, -0.5805723071098328, -0.5009326934814453, -2.0196962356567383, 0.6390368342399597, 0.2201942503452301, 0.44019633531570435, -1.390336513519287, -0.5091961026191711, 0.30772751569747925, -1.1405540704727173, 0.33543822169303894, -1.325713038444519, 0.4261302649974823, 0.5435088276863098, 0.12929868698120117, 1.941271424293518, -0.3615752160549164, 1.2226252555847168, 0.4764401614665985, -0.6540675163269043, 1.2497955560684204, 0.9002313017845154, 0.49272775650024414, 0.5424166321754456, 1.7496870756149292, -0.4931415021419525, 0.517845630645752, 1.6657676696777344, 0.8528230786323547, -0.22582153975963593, 1.7638626098632812, 0.26041388511657715, -0.6448659896850586, -0.21474885940551758, 1.4445606470108032, -1.6274805068969727, 2.0028395652770996, 1.0663702487945557, -1.273541808128357, 1.3826639652252197, -0.8126426935195923, -0.10976379364728928, -0.3447391390800476, 0.4890775680541992, 1.7470102310180664, -0.2899743318557739, -1.7284353971481323, 0.8152068257331848, -0.6640406250953674, -1.0408786535263062, 0.5780584216117859, 1.0174415111541748, -1.6385058164596558, 0.9363957047462463, -1.235307216644287, 0.17712394893169403, 1.8417270183563232, 0.9446681141853333, -0.8446294665336609, 0.8942895531654358, -0.5804584622383118, -0.9569439888000488, 1.3460334539413452, -1.1114486455917358, -1.510477066040039, 1.8013263940811157, 0.39110875129699707, 2.422659158706665, 1.3667930364608765, 0.2829006016254425, -0.08984843641519547, 0.36999624967575073, -1.2528741359710693, 0.7914286851882935, -1.3946901559829712, 1.1936941146850586, -1.1079769134521484, 0.38974860310554504, -1.3589154481887817, 1.0202326774597168, -1.8513754606246948, 0.6234173774719238, -0.9277347922325134, -0.6956018209457397, 2.380795478820801, -1.1607692241668701, -0.841586172580719, 1.4504750967025757, -0.41059574484825134, -0.3919389545917511, -0.4136979281902313, -0.6680782437324524, -0.5340244770050049, -1.3468506336212158, 0.5415297746658325, 1.8593915700912476, 1.8219257593154907, 0.21646468341350555, 1.8025962114334106, 0.33990174531936646, -0.3132607042789459, -0.5997156500816345, -0.1615489423274994, 0.45924925804138184, 0.3982723355293274, -0.5580041408538818, -0.4914865791797638, 0.9364550709724426, 1.0696587562561035, 0.8472620248794556, 0.5025794506072998, -0.4355246126651764, -1.458593726158142, 0.07618951797485352, -0.40844523906707764, -0.25412529706954956, 0.794949471950531, 0.6369404196739197, 0.7389209270477295, 0.12602922320365906, 1.0489140748977661, 0.277762770652771, 1.817987322807312, -0.13746385276317596, 0.24663984775543213, -0.23921853303909302, 0.9316136837005615, -0.3603171408176422, -2.9910335540771484, 2.1415364742279053, -0.01257996540516615, -0.26374921202659607, 0.8411416411399841, 0.12289326637983322, 1.2278491258621216, 0.3468190133571625, 0.6487783193588257, 0.8823524117469788, 1.698769211769104, -0.891884982585907, -1.0688838958740234, 2.3158209323883057, -0.38314810395240784, 0.9166865944862366, -0.15055178105831146, 0.21786388754844666, -1.5675158500671387, 0.14816321432590485, 1.4127658605575562, 0.8842237591743469, 0.05213722586631775, -0.055743563920259476, -0.1148395761847496, -0.6129196286201477, 0.5085339546203613, 0.6762527227401733, 0.8896737694740295, 1.1145814657211304, -1.1150989532470703, -0.43323105573654175, -0.0029341205954551697, 0.4904349446296692, -0.3019864857196808, 1.5543135404586792, 1.262534499168396, 1.8503801822662354, -0.963890552520752, 0.14559675753116608, -0.46449965238571167, 0.3904878795146942, -0.2845018208026886, 0.8714642524719238, -0.02770271524786949, 0.2534964084625244, 2.135573387145996, 0.2359427660703659, -0.1818685531616211, 0.6879501938819885, -0.312398225069046, -0.9073218703269958, -0.22547617554664612, 0.87565016746521, 1.926774024963379, -0.2252349853515625, 0.3145332634449005, 0.05754508823156357, -1.8865019083023071, -0.8104692697525024, -1.7396186590194702, -1.8522119522094727, -1.5426372289657593, -2.2098958492279053, -1.3316842317581177, -0.5621454119682312, 0.4579642713069916, -0.3086032569408417, -1.7823704481124878, 1.552706003189087, 1.4069734811782837, -1.8237593173980713, 0.9477501511573792, 1.3879772424697876, 0.547252893447876, 1.8237594366073608, 0.1340750753879547, 0.5422663688659668, 0.9137101173400879, 0.45334532856941223, 1.4622125625610352, 0.17012636363506317, -0.9222514629364014, 1.4190479516983032, -0.1712334007024765, -0.5173709392547607, 0.9933334589004517, -0.9068253040313721, 0.8419919013977051, 1.5693470239639282, -2.3327715396881104, 1.3629395961761475, -0.937544047832489, 0.4511164724826813, 0.8407281041145325, -1.316641092300415, -1.4025177955627441, -0.4280984103679657, 0.3739602267742157, -0.7267538905143738, 1.640281319618225, -0.04109526425600052, 0.2357684224843979, 1.7903611660003662, -0.74959397315979, 1.8939616680145264, -0.12825219333171844, 0.4710507392883301, 1.2235199213027954, -0.5540667772293091, 1.5412802696228027, 0.51043701171875, -0.040203798562288284, -0.9136852025985718, 0.8438605070114136, 0.523144543170929, 0.6648792624473572, 0.06379937380552292, 0.1250922828912735, 1.6864705085754395, -0.7897993326187134, 0.5825498104095459, -1.5414986610412598, 0.3177874684333801, 0.316039115190506, -0.13693106174468994, -0.29315948486328125, 0.10682065039873123, -0.570502758026123, 0.37459659576416016, 0.2658209800720215, -2.739109516143799, -0.7552708387374878, -0.8785728216171265, -1.579071044921875, -0.03903902322053909, -1.3449915647506714, -0.03788210079073906, 0.27276402711868286, -0.16769951581954956, -0.11828094720840454, -1.4200334548950195, -0.8669375777244568, 0.11448691785335541, 0.256873220205307, -0.6394327878952026, 0.34865275025367737, 1.0059340000152588, 2.4429306983947754, 0.7281179428100586, -0.48351114988327026, -1.3366811275482178, 0.5765342116355896, -1.0338770151138306, -0.9503273367881775, 1.0074330568313599, -0.4653376340866089, -0.03871854394674301, -0.0983838364481926, -0.013267059810459614, -0.43321457505226135, -0.22036269307136536, -0.16745758056640625, -0.5384703874588013, -1.2774591445922852, 0.3703825771808624, -0.0279550664126873, 0.045602887868881226, -0.47680357098579407, 0.03470993414521217, 0.4295140206813812, -1.437692403793335, 1.303469181060791, -1.4549658298492432, -1.7197654247283936, 0.7298985719680786, -1.0128717422485352, 0.40042635798454285, -1.5058953762054443, -1.3400262594223022, -0.5126433968544006, 0.7419107556343079, -0.8618159294128418, 1.338151216506958, -1.0268257856369019, 1.9003574848175049, 0.15587446093559265, 0.38122934103012085, -0.4994736611843109, 0.883060097694397, -1.7079987525939941, -1.5415080785751343, -0.4003807604312897, 0.041355375200510025, -0.7072992324829102, -0.3847770094871521, -1.308766484260559, 0.14602316915988922, -0.3743171989917755, -0.35921940207481384, -1.1433753967285156, 0.5064452886581421, -0.2727915942668915, -1.0194774866104126, -0.1660723239183426, 1.1014708280563354, 0.37453967332839966, -1.502211570739746, -0.717968225479126, 0.359651654958725, -0.5129573941230774, -1.2518702745437622, 0.4339846074581146, -0.2789837718009949, -0.7540116310119629, 1.2704439163208008, -2.0806050300598145, 1.670113205909729, 0.19118428230285645, -0.07117528468370438, 0.6411556601524353, -0.9380844831466675, 0.46705952286720276, -2.0166022777557373, 0.751294732093811, 0.8445814847946167, -0.8132057785987854, -0.8597244620323181, 0.940191388130188, -0.6558897495269775, -0.8142707347869873, 0.18006570637226105, 0.8451068997383118, -0.7175623178482056, 0.08882410079240799, -0.9068261384963989, -0.546160101890564, 0.36292168498039246};
    float output[10];
    forward(input, output);
    for (int i = 0; i < 10; i++)
    {
        printf("%f  ", output[i]);
    }
    return 0;
}